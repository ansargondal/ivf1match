<?php

<?
php



error_reporting(E_ALL ^ E_DEPRECATED);
ini_set('display_errors', 0);


require('server.php');  require('email.php');  session_set_cookie_params(0);  session_start();  $update = false;  $form_pages = array('contact', 'education', 'lifestyle', 'medicalhistory', 'profile', 'sexualhistory', 'done');  if (isset($_SESSION['role'])) {
    $role = $_SESSION['role'];
}  if (isset($_POST['email']) && $_POST['email'] != '' && $_SESSION['email'] == null) {
    $_SESSION['email'] = $_POST['email'];
} else if (isset($_SESSION['email'])) {
    $_POST['email'] = $_SESSION['email'];
}  /* Connect to the database*/  $conn = mysql_connect($dbhost, $dbuser, $dbpass) or mail($email_admin, "IVF1Match Database Error", "Failed to Connect to IVF1match Database");  mysql_select_db($dbname);  /*get current page name to build browsing pages*/  $curr_page_name = page_name($_SERVER["SCRIPT_NAME"]);  /*grab previous page name used in inserting into tables.*/  $page_name = page_name($_SERVER['HTTP_REFERER']);  if (isset($_SESSION['email']) && in_array($curr_page_name, $form_pages)) {    /*grab data for the page unless the page is the completed application screen*/
    if ($curr_page_name != 'done') {
        $sql = "select * from $curr_page_name where email = '$_SESSION[email]'";
        $result = mysql_query($sql);
        $row = mysql_fetch_assoc($result);
    }
}  /*if this page was posted to insert POST array or do a login*/  if ($_SERVER['REQUEST_METHOD'] == "POST") {    /* Prevent empty email bug*/
    if ($page_name != 'user' && (!isset($_SESSION['email']) || $_SESSION['email'] == '')) {
        header("Location: {$BaseURL}admin/index.php");
        die();
    }    /*retrieve page name of previous page to determine what action to take*/
    $page_url = $_SERVER['HTTP_REFERER'];    /* I think what the code below is doing is setting UPDATE vs INSERT if there is a hyphen*/    /* in the page title because hyphenated pages are updates to existing pages.*/
    if (strpos($page_url, '-')) {
        $update = TRUE;
    }
    if ($_POST['update']) {
        $update = TRUE;
        unset ($_POST['update']);
    }    /* Test table we are updating already exists to determine if this is an update or an insert.*/
    if ($page_name != 'index') {
        $sql = "select * from $page_name where email = '$_SESSION[email]'";
        $result2 = mysql_query($sql);
        $check = mysql_fetch_assoc($result2);
        if ($check) {
            $update = true;
        }
    }    /*log the user in if they came from login*/
    if ($page_name == "login") {
        login($_POST['user'], $_POST['pass']);
    } else {      /*if a user exists with that email then send them an error page*/
        $form_page = true;
        if ($page_name == 'user' && dupe_user($_SESSION['email'], $page_name)) {
            include('header.php');
            echo "<h2>A user with this email already exists.</h2> " . "<p>If " . $_SESSION['email'] . " is you, please <a href=\"admin/login.php" . "\">login</a> to continue</p>";
            include('footer.php');
            unset($_SESSION['email']);
            die();
        }
        if ($page_name == "profile") {        /*save profile pictures*/
            save_pics();
        }      /*Build SQL dynamically based on the previous page*/
        if ($update) {
            $sql = create_update($page_name);
        } else {
            $sql = create_insert($page_name);
        }
        if ($sql) {
            $result = mysql_query($sql);
            if ($result && $page_name == 'user') {          /* If new user, add email and role to session*/
                $_SESSION['role'] = 'donor';
                $_SESSION['email'] = $_POST['email'];
            }
            if ($_SESSION['role'] != 'admin') {          /* Add log entry*/
                $action = $update ? "Updated $page_name" : "Created $page_name";
                $query = create_signup_log_query($_SESSION['email'], $action, mysql_real_escape_string($sql));
                mysql_query($query);
            }
        }
    }
} else {    /*exclude landing pages which aren't for browsing the database (Sign Ups)*/
    if ($curr_page_name != "user") {
        $output = create_page($curr_page_name);
    }
}  /*----------------------------------------------------------------/*  /*Add a user to the database                                      /*  /* IS THIS ACTUALLY USED???*/  function add_user($email, $pass, $role)
{
    $salt = bin2hex(mcrypt_create_iv(32, MCRYPT_DEV_URANDOM));
    $hash = hash('sha256', $salt . $pass);
    $sql = "insert into user (email, role, status, password, salt) values ('$email', '$role', 'new', '$hash', '$salt')";
    mysql_query($sql);
}  function create_signup_log_query($email, $action, $query = NULL)
{
    $query = "INSERT INTO signup_log (email, action, query, datetime) " . "VALUES ('$email', '$action', '$query', NOW())";
    return $query;
}  /*Check to see if the user's email already exists in that table   */  function dupe_user($email, $table)
{
    $sql = "select email from $table where email = '$email'";    /*echo $sql;*/
    return mysql_num_rows(mysql_query($sql));
}  /*Create a select statement based on the page being viewed        */  function create_page($page_name)
{
    if ($page_name == "donors") {
        $sql = "select user.code, user.id, photo1, contact.birth, weight, race, " . "haircolor as 'hair', eyecolor as 'eyes', contact.state, user.cycle " . "from profile, user, contact " . "where user.email = profile.email " . "and profile.email = contact.email " . "and user.role = 'donor' " . "and user.status like 'active'";
        $output = build_overview($sql);
    }
    if ($page_name == "donordetails") {
        $id = mysql_real_escape_string($_GET['id']);
        ctype_digit($id) or die();
        $sql = "select profile.*, user.code, user.id, user.cycle, contact.state, contact.birth " . "from profile, user, contact " . "where profile.email = user.email " . "and user.email = contact.email " . "and user.status like 'active'" . "and user.id = $id";
        $output = build_details($sql);
    }    /*echo $sql;*/
    return $output;
}  /*Build the donors in table format for the given sql             */  function build_overview($sql)
{
    global $BaseURL;
    $exists = array();
    $nav = '<div class="menu-container">';
    $menus = array();
    $menu_titles = array('Race', 'Hair', 'Eyes', 'Local');
    $i = 0;
    $content = '<ul id="donors" class="donors">';
    $result = mysql_query($sql);
    while ($row = mysql_fetch_assoc($result)) {      /*Output donor code if it exists. Otherwise, use the ID.*/
        $code = false;      /*output profile cell*/
        $cell = '';      /*Hide profiles on page load*/
        $classes = 'hidden ';
        foreach ($row as $column => $value) {
            if ($column == 'code') {
                if ($value != '') {
                    $cell .= "<h3>Donor #$value</h3>";
                    $code = true;
                }
            } elseif ($column == 'birth') {
                $age = calculate_age($value);
                $cell .= "<b>age:</b> $age <br />\n";
            } else if ($column == 'id') {
                if (!$code) {
                    $cell .= "<h3>Donor #$value</h3>";
                }
                $cell .= "<div class=\"left\"><a href=./donordetails.php?id=$value>";
            } else if ($column == 'photo1') {
                if ($value) {
                    $cell .= "<img class=\"overview\" src=\"$BaseURL$value\" width=\"100px\" /></a></div>";
                }
            } else if ($column == 'state') {
                $value = strtolower($value);
                if ($value == 'il' || $value == 'illinois') {
                    $classes .= 'yes ';
                    $cell .= "<b>Local:</b> yes <br />\n";
                } else {
                    $classes .= 'no ';
                    $cell .= "<b>Local:</b> no <br />\n";
                }
            } else if ($column == 'cycle') {
                $value = ucwords($value);
                $cell .= "<b>$column: <span class=\"lred\">$value</span></b><br />\n";
            } else {
                if ($column != 'weight') {
                    $value = trim(strtolower($value));
                    $class = str_replace(' / ', '-', $value);
                    $class = str_replace('/ ', '-', $class);
                    $class = str_replace(' ', '-', $class);
                    $class = str_replace('/', '-', $class);
                    $classes .= $class . ' ';
                    if (!in_array($value, $exists)) {
                        $exists[] = $value;
                        if ($column == 'race') {
                            $menus[0][] = '<li><input type="checkbox" name="race" value="' . $value . '"><span>' . $value . '</span></li>';
                        } elseif ($column == 'hair') {
                            $menus[1][] = '<li><input type="checkbox" name="hair" value="' . $value . '"><span>' . $value . '</span></li>';
                        } elseif ($column == 'eyes') {
                            $menus[2][] = '<li><input type="checkbox" name="eyes" value="' . $value . '"><span>' . $value . '</span></li>';
                        }
                    }
                }
                $cell .= "<b>$column:</b> $value <br />\n";
            }
        }
        $classes = trim(strtolower($classes));
        $content .= '<li class="' . $classes . '">' . $cell . '</li>';
    }
    $menus[3][] = '<li><input type="checkbox" name="local" value="yes"><span>yes</span></li>';
    $menus[3][] = '<li><input type="checkbox" name="local" value="no"><span>no</span></li>';
    foreach ($menus as $menu) {
        $nav .= '<div class="menu"><fieldset>';
        $nav .= "<legend><h2>$menu_titles[$i]</h2></legend>";
        $nav .= '<ul id="filter">';
        foreach ($menu as $item) {
            $nav .= $item;
        }
        $nav .= '</ul></div>';
        $i++;
    }
    $nav .= '</ul></fieldset></div>';
    $content .= "</ul>\n";
    $output = $nav . $content;
    return $output;
}  /*Build the donors details for the given sql                     */  function build_details($sql)
{
    $result = mysql_query($sql);
    $row = mysql_fetch_assoc($result);
    $row['age'] = calculate_age($row['birth']);
    return $row;
}  function calculate_age($birth)
{
    if (!preg_match('/^\d{1,2}\/\d{1,2}\/\d{4}$/', $birth)) {
        return '';
    } else {
        list($m, $d, $y) = explode('/', $birth);
        if ((date('m') - $m) < 0) {
            $y++;
        } elseif ((date('m') - $m) == 0 && (date('d') - $d) < 0) {
            $y++;
        }
        return date('Y') - $y;
    }
}  /*Separates the extension from the file name*/  function findexts($filename)
{
    return pathinfo($filename, PATHINFO_EXTENSION);
}  /*Save profile pictures */  function save_pics()
{
    for ($i = 1; $i <= 5; $i++) {
        if ($_FILES["photo$i"]['name']) {
            if (($_FILES["photo$i"]["type"] == "image/gif") || ($_FILES["photo$i"]["type"] == "image/jpeg") || ($_FILES["photo$i"]["type"] == "image/pjpeg") || ($_FILES["photo$i"]["type"] == "image/tiff") || ($_FILES["photo$i"]["type"] == "image/bmp") || ($_FILES["photo$i"]["type"] == "image/png") || ($_FILES["photo$i"]["type"] == "image/x-png")) {
                if ($_FILES["photo$i"]["error"] > 0) {
                    echo "I'm sorry there was an error uploading your images: " . $_FILES["photo$i"]["error"] . "<br />";
                } else {            /*create a random filename*/
                    $ran = rand();
                    $ran = $ran . ".";            /*find the extension*/
                    $exts = findexts($_FILES["photo$i"]["name"]);
                    move_uploaded_file($_FILES["photo$i"]["tmp_name"], "upload/" . $ran . $exts);            /*Set post for database storage*/
                    $_POST["photo$i"] = "upload/" . $ran . $exts;
                }
            } else {
                echo "Photo $i is not a jpeg, png, or gif. Please save your picture as a .jpg before uploading it.<br />";
            }
        }
    }
}  /*Generate the SQL statement to update the user's data.            */  function create_update($page_name)
{   /*remove mouse position so it isn't inserted.*/
    unset($_POST['x']);
    unset($_POST['y']);    /*Create the SQL statement.*/
    $sql = "update $page_name SET ";
    foreach ($_POST as $key => $value) {
        if (is_array($value)) {
            $sql .= "$key =";
            foreach ($value as $element => $data) {          /*$data = mysql_real_escape_string($data);*/
                $sql .= "'$data, '";
            }
            $sql .= "', ";
        } else {        /*$value = mysql_real_escape_string($value);*/
            $value = trim($value);
            $sql .= "$key='$value', ";
            $added = true;
        }
    }    /*Remove the extra comma*/
    if ($added) {
        $sql = substr_replace(trim($sql), "", -1);
        $sql .= " where email = '" . $_SESSION['email'] . "'";
        return $sql;
    }
    return false;
}  /*Generate the SQL statement to insert the user's data.*/  function create_insert($page_name)
{    /*remove mouse position so it isn't inserted.*/
    unset($_POST['x']);
    unset($_POST['y']);    /*Create the SQL statement.*/
    $sql_start = "insert into $page_name (";
    $sql_end = ") values (";    /*Add the email key if it's in session and not post.*/
    if (!$_POST['email'] && $_SESSION['email']) {
        $sql_start .= "email, ";
        $sql_end .= "'" . $_SESSION['email'] . "', ";
    }    /* Some trickery to get hashed passwords into database      Also need to prevent attacks and drop values not in DB*/
    if ($page_name == 'user' || $page_name == 'recipient') {      /* It appears 'recipient' never actually reaches this*/
        $salt = bin2hex(mcrypt_create_iv(32, MCRYPT_DEV_URANDOM));
        $password = hash('sha256', $salt . $_POST['pass']);
        $_POST['salt'] = $salt;
        $_POST['password'] = $password;
        $_POST['last_login'] = date('Y-m-d H:i:s');
        unset($_POST['pass']);    /* No longer using this field*/
        unset($_POST['submit']);  /* This gets set in POST somewhere...*/
        unset($_POST['role']);    /* Prevent intruder from defining role*/      /* If donor, initial status 'incomplete'. If recipient, initial status 'new'.*/
        $_POST['status'] = ($page_name == 'user') ? 'incomplete' : 'new';
    }    /* This is not the most secure way of doing things...*/
    foreach ($_POST as $key => $value) {
        if (is_array($value)) {
            $sql_start .= "$key, ";
            $sql_end .= "'";
            foreach ($value as $element => $data) {
                $sql_end .= "$data, ";
            }
            $sql_end .= "', ";
        } else {
            $value = trim($value);        /*remove empty fields so the default value is used*/
            if ($value != '') {
                $sql_start .= "$key, ";
                $sql_end .= "'$value', ";
                $added = true;
            }
        }
    }
    if ($added) {      /*Remove the extra comma*/
        $sql_start = substr_replace(trim($sql_start), "", -1);
        $sql_end = substr_replace(trim($sql_end), "", -1);
    }    /*finish SQL statement*/
    $sql_end .= ")";
    return "$sql_start $sql_end";
}  /* Is THIS ever used???*/  function login($email, $pass)
{
    $query = "SELECT password, salt FROM user WHERE email='$email'";
    $result = mysql_query($query);
    $user = mysql_fetch_assoc($result);
    $salt = $user['salt'];
    $hash = hash('sha256', $salt . $pass);
    $query = "SELECT role, email FROM user WHERE email='$email' AND password='$hash'";
    $result = mysql_query($query);    /* If the login matches, register a user role.*/
    if ($row = mysql_fetch_assoc($result)) {
        $_SESSION['role'] = $row['role'];
        $_SESSION['email'] = $row['email'];
    } else {
        echo "Wrong Username or Password";
    }
}  function page_name($page_path)
{
    $slash_idx = strrpos($page_path, "/");
    $page_name = substr($page_path, $slash_idx + 1);    /*strip the extension*/
    $ext = strrchr($page_name, '.');
    $page_name = substr($page_name, 0, -strlen($ext));    /*strip the -more to get tablename correct.*/
    if ($page = substr($page_name, 0, strpos($page_name, '-'))) {
        $page_name = $page;
    }
    return $page_name;
}
 ?>